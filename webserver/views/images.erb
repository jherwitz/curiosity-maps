<!doctype html>
<html>
    <head>
    <title>Curiosity image view</title>
    <link rel="stylesheet" type="text/css" href="//s3-us-west-2.amazonaws.com/curiosity-maps/slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="/styles/images.css"/>
    </head>

    <body>

    <div id="close" class="close quietable"></div>

    <div class="controls <%= images.any? ? "hasimages" : "noimages" %> quietable">
        <div class="message"> Change image set: </div>
        <div class="sol">
            <span class="message">Sol </span><input id="sol" type="text" value="<%= images.any? ? images[0].sol : 0 %>">
       </div>
       <div class="camera">
            <span class="message">Cam </span>
            <select id="camera" class="cameras">
                <option value="Mastcam">Mastcam</option>
                <option value="FrontHazcam">Front Hazcam</option>
                <option value="LeftNavcam">Left Navcam</option>
                <option value="RearHazcam">Rear Hazcam</option>
                <option value="RightNavcam">Right Navcam</option>
            </select>
       </div>
    </div>

    <% if images.any?  %>
        <img class="snake" src="//s3-us-west-2.amazonaws.com/curiosity-maps-assets/icons/snake.gif"/>
    <% end %>

    <div class="images">
    <% images.each do |image| %>
        <div>
            <img class="image" data-lazy="<%= image.imageUrl %>">
        </div>
    <% end %>
    </div>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="//s3-us-west-2.amazonaws.com/curiosity-maps/slick/slick.min.js"></script>

    <script type="text/javascript">
        // add frame controls if we're in an iframe
        window.addEventListener("message", function(event){
            if(!event.data){
                return;
            }

            var message = JSON.parse(event.data);
            // TODO: origin check
            if(message.type === "open"){
                document.getElementById("close").style.display = "block";
            }
        }, false);
        $("#close").click(function() {
            window.postMessage(JSON.stringify({type: "close"}), "*");
        });
        $(document).keydown(function(e) {
            // close on 'esc' press
            if (e.keyCode == 27) { 
                window.postMessage(JSON.stringify({type: "close"}), "*");
            }   
        });
        $(".controls .sol").keydown(function (e) {
            if (e.keyCode == 13) {
                var message = JSON.stringify({type: "redirect", sol: $("#sol").val(), camera: $("#camera").val()});
                console.log("sol fired with: " + message);
                window.postMessage(message, "*");
            }
        });
        $(".controls .camera").change(function (e) {
            var message = JSON.stringify({type: "redirect", sol: $("#sol").val(), camera: $("#camera").val()});
            console.log("sol fired with: " + message);
            window.postMessage(message, "*");
        });

        var fade;
        $(document).mousemove(function(event) {
            $(".quietable").fadeIn();
            $(".slick-prev").fadeIn();
            $(".slick-next").fadeIn();
            $('html').css({
                cursor: 'default'
            });
            if(fade) { clearTimeout(fade); }

            fade = setTimeout(function() {
                $(".quietable").fadeOut();
                $(".slick-prev").fadeOut();
                $(".slick-next").fadeOut();
                $('html').css({
                cursor: 'none'
            });
            }, 3000);
        });


        $(document).ready(function(){
            // initialize carousel
            $('.images').slick({
                speed: 300,
                infinite: true,
                slidesToShow: 1,
                touchThreshold: 25,
                lazyLoad: 'ondemand'
            });
        });


        fade = setTimeout(function() {
            $(".quietable").fadeOut();
            $(".slick-prev").fadeOut();
            $(".slick-next").fadeOut();
            $('html').css({
                cursor: 'none'
            });
        }, 3000);
    </script>

    <div class="footer">

        <% if images.any?  %>
            <div class="message">
            Images taken by Curiosity on sol <span class="sollbl"><%= images[0].sol %></span> using camera <span class="cameralbl"><%= images[0].camera %>.</span>
            </div>
            <div class="message">
            Navigate left and right with click-and-drag or the arrow keys.
            </div>
        <% else %>
        <div class="message">
            No images found for the requested sol and camera.
        </div>
        <% end %>  

        <div class="message">
            Location and image data courtesy NASA/JPL-Caltech. For more information, see the <a href="http://www.jpl.nasa.gov/imagepolicy/">JPL Image Use Policy</a> and the <a href="http://data.nasa.gov/about/">Open NASA Project</a>.
        </div>
        <div class="message">
            See more on <a href="http://www.github.com/jherwitz">Github</a>. (Soon!)
        </div>
    </div>

    </body>
</html>
