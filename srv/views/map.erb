<!DOCTYPE html>
<html>
<head>
<title>Curiosity Maps</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
.labels {
     color: red;
     background-color: white;
     font-family: "Lucida Grande", "Arial", sans-serif;
     font-size: 10px;
     font-weight: bold;
     text-align: center;
     width: 40px;     
     border: 2px solid black;
     white-space: nowrap;
   }
html { overflow: hidden; }
body { overflow: hidden; padding: 0; margin: 0;
width: 100%; height: 100%; font-family: Trebuchet MS, Trebuchet, Arial, sans-serif; }
#map { position: absolute; top: 10px; left: 10px; right: 10px; bottom: 15px; overflow: auto; }
#footer { position: absolute; bottom: 0px; left: 0px; width:100%; height: 12px; overflow: hidden; }
@media screen and (max-width: 600px) {
  #map { top:0px; left:0px; width:100%; height:100%;}
}
body { background: #f4f4f4;}
#header { background: #fff; box-shadow: 0 1px 3px #CCC; border: 1px solid #ccc; }
#header h1 { padding:7px 10px; margin:0; font-size: 28px; }
#map { border: 1px solid #ccc; box-shadow: 0 1px 3px #CCC; background-color: #DEDCD7;}
.images {
    width: 100% !important;
    height: 100% !important;
    z-index: 2147483647 !important;
    position: absolute;
    display: none;
}
.cameras {
    position: absolute;
    right: 20px;
    top: 25px;
    z-index: 2147483647 !important;
}
</style>
<!--[if lte IE 6]>
<style type="text/css">
#map {
    height:expression(document.body.clientHeight-35); /* 10+10+15=35 */
    width:expression(document.body.clientWidth-20); /* 10+10=20 */
}
</style>
<![endif]-->
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
var lookupTable = <%= lookupTable.to_json %>;
var markers = [];

var map;
var mapBounds = new google.maps.LatLngBounds(
    new google.maps.LatLng(-5.991029, 135.918796),
    new google.maps.LatLng(-2.989471, 138.919805));
var mapMinZoom = 6;
var mapMaxZoom = 13;

// proposed landing site according to usgs, "MSL_LANDING_SITE" in spice
var mslLandingSite = new google.maps.LatLng(-4.490250, 137.419301);

var maptiler = new google.maps.ImageMapType({
    getTileUrl: function(coord, zoom) { 
        var proj = map.getProjection();
        var z2 = Math.pow(2, zoom);
        var tileXSize = 256 / z2;
        var tileYSize = 256 / z2;
        var tileBounds = new google.maps.LatLngBounds(
            proj.fromPointToLatLng(new google.maps.Point(coord.x * tileXSize, (coord.y + 1) * tileYSize)),
            proj.fromPointToLatLng(new google.maps.Point((coord.x + 1) * tileXSize, coord.y * tileYSize))
        );
        var y = coord.y;
        if (mapBounds.intersects(tileBounds) && (mapMinZoom <= zoom) && (zoom <= mapMaxZoom))
            return "https://s3-us-west-2.amazonaws.com/curiosity-maps-assets/" + zoom + "/" + coord.x + "/" + y + ".png";
        else
            return "http://www.maptiler.org/img/none.png";
    },
    tileSize: new google.maps.Size(256, 256),
    isPng: true,
  name: "MapTiler",
  alt: "MapTiler",
  minZoom: mapMinZoom,
  maxZoom: mapMaxZoom
});
function init() {
    var opts = {
        streetViewControl: false,
        mapTypeId: 'maptiler',
        backgroundColor: "rgb(0,0,0)",
        center: mslLandingSite,
        zoom: 10,
        scaleControl: true,
        mapTypeControlOptions: {
            mapTypeIds: []
        },
    }
    map = new google.maps.Map(document.getElementById("map"), opts);
    map.mapTypes.set('maptiler', maptiler);


    // for reference
    var position = new google.maps.LatLng(-4.490250, 137.419301);
    var marker = new google.maps.Marker({
        position: position,
        map: map,
        title: 'Gale Crater (Proposed Curiosity landing site)'
    });

    var path = [];
    <% locations.each do |location| %>
        position = new google.maps.LatLng(mslLandingSite.lat() + <%= location.lat() %>, mslLandingSite.lng() + <%= location.lng() %>);
        path.push(position);
        marker = new google.maps.Marker({
            position: position,
            map: map,
            title: "Sol <%=location.sol() %>"
        });
        google.maps.event.addListener(marker, 'click', function() {
            var iframe = document.createElement("iframe");
            var camera = document.getElementById("cameras").value;
            iframe.src = "/images/<%= location.sol() %>/" + camera;
            iframe.className = "images";
            iframe.onload = function() {
                iframe.contentWindow.addEventListener("message", function(event) {
                    if(event.data === "close") {
                        // it'll be http cached later anyways
                        iframe.parentNode.removeChild(iframe);
                    }
                });
                iframe.contentWindow.postMessage("open", "*");
                iframe.style.display = "block";
                iframe.contentWindow.focus();
            }
            document.body.appendChild(iframe);
        });
        markers.push({marker: marker, sol: <%= location.sol() %>});
    <% end %>

    var polyline = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
    });

    polyline.setMap(map);

    maskMarkers();
}

function maskMarkers() {
    var camera = document.getElementById("cameras").value;
    for(var i=0; i<markers.length; i++) {
        // could really just use i=sol, but lets do the object lookup just to be safe
        if(!lookupTable[camera][markers[i].sol]) {
            markers[i].marker.setVisible(false);
        } else {
            markers[i].marker.setVisible(true);
        }
    }
    
}

</script>
</head>
<body onload="init()">
    <div id="map"></div>
    <select onchange="maskMarkers()" id="cameras" class="cameras">
        <option value="FrontHazcam">Front Hazcam</option>
        <option value="LeftNavcam">Left Navcam</option>
        <option value="Mastcam">Mastcam</option>
        <option value="RearHazcam">Rear Hazcam</option>
        <option value="RightNavcam">Right Navcam</option>
    </select>
</body>
</html>
